<!doctype html>
<meta charset="utf-8" />
<link href="styles.css" rel="stylesheet" />
<form>
  <label>
    Choose a distribution
    <select id="dist-selector">
      <option value="even">Even</option>
      <option value="us">United States</option>
      <option value="us-youth">United States Youth</option>
    </select>
  </label>
  <button id="roll-button">Roll Again</button>
</form>
<section>
  <div>
    <header>Without the Plugin</header>
    <ul class="control"/>
  </div>
  <div>
    <header>With the Plugin</header>
    <ul class="experiment"/>
  </div>
</section>

<script>
  const distributions = {
                   /* light ---------- dark */
    'even'       : [ 0.2, 0.2, 0.2, 0.2, 0.2 ],
    'us'         : [ 0.3, 0.1, 0.2, 0.3, 0.1 ],
    'us-youth'   : [ 0.1, 0.2, 0.2, 0.3, 0.2 ]
  }

  const skintoneEligible = 'ðŸ‘¦ ðŸ‘§ ðŸ‘¨ ðŸ‘© ðŸ‘´ ðŸ‘µ ðŸ‘¶ ðŸ‘± ðŸ‘¼ ðŸ‘¸ ðŸ‘² ðŸ‘³ ðŸ‘® ðŸ‘· ðŸ’‚ ðŸ‘¯ ðŸ™† ðŸ™… ðŸ’ ðŸ™‹ ðŸ’† ðŸ’‡ ðŸ‘° ðŸ™Ž ðŸ™ ðŸ™‡ ðŸ‘ ðŸ‘Ž ðŸ‘Œ ðŸ‘Š âœŠ ðŸ‘‹ âœ‹ ðŸ‘ ðŸ‘† ðŸ‘‡ ðŸ‘‰ ðŸ‘ˆ ðŸ™Œ ðŸ™ ðŸ‘ ðŸ’ª ðŸš¶ ðŸƒ ðŸ’ƒ ðŸŽ… ðŸŠ ðŸ„ ðŸ›€ ðŸšµ ðŸš´ ðŸ‡'.split(' ')
  const skintones = 'ðŸ» ðŸ¼ ðŸ½ ðŸ¾ ðŸ¿'.split(' ')

  const spec = skintoneEligible.map((emoji, index) => index % 3 === 0 ? emoji + skintones[index % 5] : emoji)

  const noSkintonePattern = new RegExp(`(${skintoneEligible.join('|')})([^${skintones.join('')}]|$)`, 'gm')
  console.log(noSkintonePattern);

  window.onload = () => {
    const distSelector = document.querySelector('#dist-selector')
    distSelector.onchange = () => {
      console.log(distSelector.value)
    }

    const rollButton = document.querySelector('#roll-button')
    rollButton.onclick = e => {
      e.preventDefault()
      randomizeSkintones();
    }

    const controlGroup = document.querySelector('.control')
    controlGroup.innerHTML = spec.map(emoji => `<li>${emoji}</li>`).join('\n')

    randomizeSkintones()
  }

  function randomizeSkintones() {
    const experiment = document.querySelector('.experiment')
    experiment.innerHTML = spec.map(emoji => `<li>${emoji}</li>`).join('\n')

    walkTree(experiment, node => {
      node.nodeValue = node.nodeValue.replace(noSkintonePattern, (_, emoji) => emoji + skintones[Math.floor(Math.random()*skintones.length)])
    })
  }

  function walkTree(node, mutator) {
    // Adapted from Cloud to Butt: https://github.com/panicsteve/cloud-to-butt/blob/master/Source/content_script.js
    let child, next

    if (node.tagName && node.classList && (
      node.tagName.toLowerCase() === 'input' ||
      node.tagName.toLowerCase() === 'textarea' ||
      node.classList.contains('ace_editor')
    )) { return }

    switch ( node.nodeType ) {
      case 1:  // Element
      case 9:  // Document
      case 11: // Document fragment
        child = node.firstChild
        while (child) {
          next = child.nextSibling
          walkTree(child, mutator)
          child = next
        }
        break;
      case 3: // Text node
        mutator(node)
    }
  }
</script>
